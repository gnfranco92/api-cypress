name: CI - Cypress

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  cypress-tests:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout do reposit√≥rio (Mantido igual)
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # üîπ Certifica que todo o reposit√≥rio √© baixado

      # 2Ô∏è‚É£ Configurar Node.js (Movido para antes da instala√ß√£o das depend√™ncias)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'

      # 3Ô∏è‚É£ Limpar cache do Node.js (Mantido igual)
      - name: Limpar cache do Node.js
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Limpar cache do GitHub Actions
        run: rm -rf .git

      # 4Ô∏è‚É£ Instalar depend√™ncias (Movido antes da verifica√ß√£o de arquivos)
      - name: Install Dependencies
        run: npm ci  # üîπ Agora todas as depend√™ncias s√£o instaladas antes de verificar arquivos

      # 5Ô∏è‚É£ Verificar arquivos na pipeline (Movido para depois da instala√ß√£o)
      - name: Verificar arquivos na pipeline
        run: ls -R cypress/e2e/features/  # üîπ Agora s√≥ roda depois das depend√™ncias estarem instaladas

      # 6Ô∏è‚É£ Executar os testes do Cypress
      - name: Run Cypress Tests + Cucumber
        run: |
          npx cypress run --spec "cypress/e2e/features/**/*.feature"

      # 7Ô∏è‚É£ Gerar o relat√≥rio HTML consolidado
      - name: Generate Test Report
        run: |
          npx mochawesome-merge cypress/reports/*.json > cypress/reports/report.json
          npx mochawesome-report-generator cypress/reports/report.json -o cypress/reports/html

      # 8Ô∏è‚É£ Fazer upload do relat√≥rio como artefato
      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: cypress-test-report
          path: cypress/reports/html/
